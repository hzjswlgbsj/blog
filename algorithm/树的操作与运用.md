# æ ‘çš„æ“ä½œä¸è¿ç”¨

æ ‘ç»“æ„åœ¨å‰ç«¯å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œæ— è®ºæ˜¯æƒé™èœå•ã€åˆ†ç±»ç®¡ç†ï¼Œè¿˜æ˜¯ç»„ç»‡æ¶æ„å›¾ï¼Œå‡ ä¹éƒ½ç¦»ä¸å¼€æ ‘å½¢æ•°æ®ã€‚æœ¬æ–‡å°†ä»åŸºç¡€æ“ä½œè®²èµ·ï¼Œé€æ­¥å¸¦ä½ äº†è§£æ ‘çš„æ„å»ºã€æ“ä½œã€æœç´¢ã€åºåˆ—åŒ–ã€ç»“æ„è®¾è®¡ç­‰å†…å®¹ï¼Œå¸®åŠ©ä½ å»ºç«‹å®Œæ•´çš„æ ‘ç»“æ„çŸ¥è¯†ä½“ç³»ã€‚

---

## ä¸€ã€æ ‘çš„åŸºç¡€æ“ä½œ

### æ–°å¢èŠ‚ç‚¹

æ ‘ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ï¼Œé€šå¸¸æ˜¯å°†ä¸€ä¸ªæ–°èŠ‚ç‚¹æ·»åŠ åˆ°æŒ‡å®šçˆ¶èŠ‚ç‚¹çš„ `children` æ•°ç»„ä¸­ã€‚ä¾‹å¦‚ï¼š

```ts
function addChild(tree, parentId, newNode) {
  for (const node of tree) {
    if (node.id === parentId) {
      node.children = node.children || [];
      node.children.push(newNode);
      return true;
    }
    if (node.children && addChild(node.children, parentId, newNode)) {
      return true;
    }
  }
  return false;
}
```

å¦‚æœæ ‘è¦æ±‚æœ‰åºï¼Œæ¯”å¦‚æŒ‰åç§°æ’åºï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ ¹æ®æŸä¸ªè§„åˆ™å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°æŒ‡å®šä½ç½®ã€‚

### åˆ é™¤èŠ‚ç‚¹

åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ç§ç­–ç•¥ï¼š

1. **è¿åŒå­èŠ‚ç‚¹ä¸€èµ·åˆ é™¤**ï¼šé€‚ç”¨äºæƒé™èœå•ã€ç»„ç»‡æ¶æ„ç­‰éœ€è¦å®Œæ•´ç§»é™¤çš„æƒ…å†µã€‚
2. **å­èŠ‚ç‚¹æå‡ä¸€çº§æˆ–äº¤ç»™ä¸Šçº§ç®¡ç†**ï¼šä¾‹å¦‚æŸäº›ç”µå•†åˆ†ç±»ï¼Œå½“ä¸­é—´å±‚çº§åˆ é™¤æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¿ç•™å…¶å­åˆ†ç±»ã€‚

ç¤ºä¾‹ï¼šé€’å½’åˆ é™¤æŸä¸ª `id` çš„èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹ã€‚

```ts
function deleteNode(tree, nodeId) {
  return tree.filter((node) => {
    if (node.id === nodeId) return false;
    if (node.children) {
      node.children = deleteNode(node.children, nodeId);
    }
    return true;
  });
}
```

### æ›´æ–°èŠ‚ç‚¹

æ›´æ–°æ“ä½œå¾ˆå¸¸è§ï¼Œæ¯”å¦‚ä¿®æ”¹èŠ‚ç‚¹åç§°ã€çŠ¶æ€ã€æ‰©å±•å­—æ®µç­‰ï¼š

```ts
function updateNode(tree, nodeId, patch) {
  for (const node of tree) {
    if (node.id === nodeId) {
      Object.assign(node, patch);
      return true;
    }
    if (node.children && updateNode(node.children, nodeId, patch)) {
      return true;
    }
  }
  return false;
}
```

### ç§»åŠ¨èŠ‚ç‚¹

æ”¯æŒæ‹–æ‹½æ“ä½œçš„æ ‘ç»„ä»¶ï¼ŒèƒŒåå°±æ˜¯èŠ‚ç‚¹çš„â€œå‰ªåˆ‡-ç²˜è´´â€æ“ä½œã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯è·¨å±‚çº§æ‹–åŠ¨å¯èƒ½å¼•èµ·**å¾ªç¯å¼•ç”¨**ï¼Œå³ä¸€ä¸ªèŠ‚ç‚¹è¢«ç§»åˆ°è‡ªå·±çš„å­å­™èŠ‚ç‚¹ä¸­ï¼Œå½¢æˆæ­»å¾ªç¯ã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç§»åŠ¨å‰åšåˆæ³•æ€§æ ¡éªŒã€‚

```ts
function isDescendant(sourceNode, targetId) {
  if (!sourceNode.children) return false;
  for (const child of sourceNode.children) {
    if (child.id === targetId || isDescendant(child, targetId)) {
      return true;
    }
  }
  return false;
}
```

---

## äºŒã€æ ‘çš„æœç´¢åŠŸèƒ½

### æ ¹æ®å…³é”®è¯æœç´¢èŠ‚ç‚¹

æˆ‘ä»¬å¸¸å¸¸éœ€è¦æ ¹æ®èŠ‚ç‚¹åç§°è¿›è¡Œæ¨¡ç³Šæœç´¢ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ª 1000 ä¸ªåˆ†ç±»çš„å•†å“åˆ†ç±»æ ‘ä¸­å¿«é€Ÿå®šä½â€œé¢éƒ¨æŠ¤ç†â€ã€‚

```ts
function searchTree(tree, keyword) {
  const result = [];
  for (const node of tree) {
    const hasMatch = node.name.includes(keyword);
    const matchedChildren = node.children
      ? searchTree(node.children, keyword)
      : [];
    if (hasMatch || matchedChildren.length) {
      result.push({
        ...node,
        children: matchedChildren,
      });
    }
  }
  return result;
}
```

### è¿”å›è·¯å¾„é“¾ï¼ˆè·¯å¾„é«˜äº®ï¼‰

å½“åŒ¹é…åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å±•ç¤ºå®Œæ•´è·¯å¾„ï¼Œå¦‚ï¼š

```
[æ ¹èŠ‚ç‚¹ â†’ åˆ†ç±»A â†’ å­åˆ†ç±»B â†’ ç›®æ ‡èŠ‚ç‚¹]
```

æˆ‘ä»¬å¯ä»¥åœ¨æœç´¢è¿‡ç¨‹ä¸­å°†è·¯å¾„ä¿å­˜ä¸‹æ¥ï¼š

```ts
function findPath(tree, targetId, path = []) {
  for (const node of tree) {
    const newPath = [...path, node];
    if (node.id === targetId) return newPath;
    if (node.children) {
      const res = findPath(node.children, targetId, newPath);
      if (res) return res;
    }
  }
  return null;
}
```

### å±•ç¤ºä¸Šä¸‹æ–‡ä¸é«˜äº®

åŒ¹é…æ—¶ä¸ä»…è¦é«˜äº®ç›®æ ‡èŠ‚ç‚¹ï¼Œä¹Ÿéœ€è¦å±•å¼€å®ƒçš„çˆ¶çº§èŠ‚ç‚¹ã€‚è¿™é€šå¸¸ç”¨äºâ€œæœç´¢åä¿ç•™ä¸Šä¸‹æ–‡â€åœºæ™¯ã€‚

---

## ä¸‰ã€æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–

### ä»€ä¹ˆæ˜¯æ ‘çš„åºåˆ—åŒ–ï¼Ÿ

åºåˆ—åŒ–æ˜¯å°†æ ‘ç»“æ„â€œæ‹æ‰â€æˆä¸€ä¸ªå¹³é¢ç»“æ„ï¼Œæ–¹ä¾¿å­˜å‚¨æˆ–ä¼ è¾“ã€‚

å¸¸è§çš„ä¸¤ç§åºåˆ—åŒ–æ–¹å¼ï¼š

#### 1. åµŒå¥—ç»“æ„ï¼ˆchildren åµŒå¥—ï¼‰

```json
{
  "id": 1,
  "name": "root",
  "children": [
    {
      "id": 2,
      "name": "child"
    }
  ]
}
```

#### 2. æ‰å¹³ç»“æ„ï¼ˆå¸¦ parentIdï¼‰

```json
[
  { "id": 1, "name": "root", "parentId": null },
  { "id": 2, "name": "child", "parentId": 1 }
]
```

### ååºåˆ—åŒ–ï¼šä»æ‰å¹³ç»“æ„è¿˜åŸæˆæ ‘

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€æ¬¡éå† + `Map` å­˜å‚¨æ–¹å¼é«˜æ•ˆæ„å»ºï¼š

```ts
function buildTree(flatList) {
  const idMap = new Map();
  const tree = [];

  for (const item of flatList) {
    idMap.set(item.id, { ...item, children: [] });
  }

  for (const item of flatList) {
    const node = idMap.get(item.id);
    if (item.parentId) {
      const parent = idMap.get(item.parentId);
      parent.children.push(node);
    } else {
      tree.push(node);
    }
  }

  return tree;
}
```

---

## å››ã€æ ‘åœ¨å‰ç«¯ä¸šåŠ¡ä¸­çš„å¸¸è§ç»“æ„è®¾è®¡

### åµŒå¥—ç»“æ„ vs æ‰å¹³æ•°ç»„

| ç»“æ„ç±»å‹ | ä¼˜ç‚¹     | ç¼ºç‚¹         |
| -------- | -------- | ------------ |
| åµŒå¥—ç»“æ„ | æ¸²æŸ“æ–¹ä¾¿ | æŸ¥æ‰¾æ…¢       |
| æ‰å¹³ç»“æ„ | æŸ¥æ‰¾é«˜æ•ˆ | æ¸²æŸ“éœ€æ„å»ºæ ‘ |

é€šå¸¸æ¨èåç«¯è¿”å›æ‰å¹³ç»“æ„ï¼Œå‰ç«¯æ ¹æ®éœ€è¦æ„å»ºåµŒå¥—ç»“æ„ã€‚

### å…¸å‹ç»“æ„å­—æ®µè®¾è®¡

- `id`ï¼šå”¯ä¸€æ ‡è¯†
- `parentId`ï¼šçˆ¶èŠ‚ç‚¹æ ‡è¯†
- `path`ï¼šä» root åˆ°å½“å‰èŠ‚ç‚¹çš„è·¯å¾„ï¼Œå¦‚ `['A', 'A-1', 'A-1-1']`
- `level`ï¼šæ ‘çš„å±‚çº§
- `hasChildren`ï¼šæ˜¯å¦æœ‰å­èŠ‚ç‚¹ï¼ˆæ‡’åŠ è½½åœºæ™¯ï¼‰

### å¯é…ç½®æ ‘ç»“æ„è®¾è®¡

å¯¹äºéœ€è¦çµæ´»æ‰©å±•çš„æ ‘ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

- ç»™èŠ‚ç‚¹åŠ ä¸Š `meta` å­—æ®µå­˜æ‰©å±•ä¿¡æ¯
- æ”¯æŒå¼‚æ­¥åŠ è½½å­èŠ‚ç‚¹ `loadChildren`
- å…è®¸é…ç½®å­—æ®µåï¼ˆå¦‚ `idField`, `childrenField`ï¼‰

---

## äº”ã€å®é™…ä¸šåŠ¡ä¸­çš„æ¡ˆä¾‹ä¸æŠ½è±¡

### æƒé™èœå•æ ‘

- æƒé™ç»“æ„å¤©ç„¶å°±æ˜¯æ ‘å½¢ç»“æ„ï¼ˆçˆ¶å­èœå•ï¼‰
- èŠ‚ç‚¹ä¸­åŒ…å«æƒé™ç ã€è·¯ç”±ã€å›¾æ ‡ç­‰æ‰©å±•å­—æ®µ
- é€šå¸¸é…åˆå¤é€‰æ¡†æ”¯æŒâ€œçˆ¶å­è”åŠ¨â€

### ç”µå•†åˆ†ç±»æ ‘

- å¤šå±‚çº§åˆ†ç±»ï¼ŒèŠ‚ç‚¹æ”¯æŒé‡æ’åº
- æ‹–æ‹½æ“ä½œéœ€è€ƒè™‘æ’åºå­—æ®µå’Œå±‚çº§é™åˆ¶
- åˆ é™¤åˆ†ç±»æ—¶éœ€ç¡®è®¤æ˜¯å¦è¿å¸¦åˆ é™¤å­åˆ†ç±»

### æµç¨‹å›¾ / ç»„ç»‡ç»“æ„å›¾

- å¯è§†åŒ–å±•ç¤ºï¼ŒèŠ‚ç‚¹å¯ç¼–è¾‘ã€ç§»åŠ¨
- åç«¯é€šå¸¸ç»´æŠ¤ flat æ•°æ®ï¼Œå‰ç«¯è´Ÿè´£ç»˜å›¾ä¸ç»“æ„æ˜ å°„

---

## å…­ã€è¿›é˜¶è¯é¢˜ï¼ˆé¢„å‘Šï¼‰

åç»­æˆ‘ä»¬è¿˜ä¼šè®¨è®ºä»¥ä¸‹è¿›é˜¶å†…å®¹ï¼š

- æ ‘ç»“æ„çš„ diff ç®—æ³•ï¼šæ¯”å¦‚ Vue3 çš„ block tree ä¼˜åŒ–ç­–ç•¥
- è™šæ‹Ÿæ»šåŠ¨å’Œæ‡’åŠ è½½ï¼šç”¨äºå¤§è§„æ¨¡æ ‘ç»“æ„çš„æ€§èƒ½ä¼˜åŒ–
- AST æŠ½è±¡è¯­æ³•æ ‘çš„æ„å»ºä¸è½¬æ¢ï¼šå¦‚ä½•å°†ä»£ç ç»“æ„è½¬æ¢ä¸ºæ ‘å¹¶åˆ†æ
- æ ‘çŠ¶ç¼“å­˜ç®¡ç†ï¼šåŸºäºä¾èµ–å…³ç³»çš„é€’å½’ç¼“å­˜è®¾è®¡

æ•¬è¯·æœŸå¾… ğŸ«¡

---
